#include "StageScene_1.h"
 
const unsigned char StageScene_1::stage1[] = {
	OX10,NAS(7,90,6), OX18,NAS(7,90,6), OX18,NAS(7,90,6), OX18,NAS(7,90,6), OX18,NAS(7,90,6),
	OX18,NAS(7,90,6), OX18,NAS(7,90,6), OX18,NAS(7,90,6), OX18,NAS(7,90,6), OX18,NAS(7,90,6),

	OX20,OX8,NAS(9,75,7), OX16,NAS(8,75,7), OX16,NAS(9,75,7), OX16,NAS(8,75,7), OX16,NAS(9,75,7),
	OX16,NAS(8,75,7), OX16,NAS(9,75,7), OX16,NAS(8,75,7), OX16,NAS(9,75,7), OX16,NAS(8,75,7),

	OX20,OX20,OX20,NAS(8,20,14),OX2,NAS(7,20,14),OX2,NAS(8,20,14),
	OX16,NAS(8,20,14),OX2,NAS(7,20,14),OX2,NAS(8,20,14),
	OX16,NAS(8,20,14),OX2,NAS(7,20,14),OX2,NAS(8,20,14),
	OX16,NAS(8,20,14),OX2,NAS(7,20,14),OX2,NAS(8,20,14),
	OX16,NAS(8,20,14),OX2,NAS(7,20,14),OX2,NAS(8,20,14),
	OX10,OX16,NAS(16,120,14),OX2,NAS(15,120,14),OX2,NAS(16,120,14),

	OX20,OX10,PNAS(8,9,40,10),OX10,PNAS(-8,9,40,10), OX10,PNAS(8,8,40,10),OX10,PNAS(-8,8,40,10),
	OX10,PNAS(8,9,40,10),OX10,PNAS(-8,9,40,10), OX10,PNAS(8,8,40,10),OX10,PNAS(-8,8,40,10),
	OX10,PNAS(8,9,40,10),OX10,PNAS(-8,9,40,10), OX10,PNAS(8,8,40,10),OX10,PNAS(-8,8,40,10),
	OX10,PNAS(8,9,40,10),OX10,PNAS(-8,9,40,10), OX10,PNAS(8,8,40,10),OX10,PNAS(-8,8,40,10),
	OX10,PNAS(8,9,40,10),OX10,PNAS(-8,9,40,10), OX10,PNAS(8,8,40,10),OX10,PNAS(-8,8,40,10),

	OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12), OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12),
	OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12), OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12),
	OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12), OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12),
	OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12), OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12),
	OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12), OX20,BNAS(6,13,90,12),OX10,BNAS(-6,13,90,12),

	OX20,NAS(15,90,3),NAS(13,75,11), OX12,NAS(15,90,3),NAS(13,75,11), OX12,NAS(15,90,3),NAS(13,75,11),
	OX12,NAS(15,90,3),NAS(13,75,11), OX12,NAS(15,90,3),NAS(13,75,11), OX12,NAS(15,90,3),NAS(13,75,11),
	OX12,NAS(15,90,3),NAS(13,75,11), OX12,NAS(15,90,3),NAS(13,75,11), OX12,NAS(15,90,3),NAS(13,75,11),

	OX20,OX20,OX20,OX20,OX20,

	OX14,NAS(13,75,11),OX2,NAS(12,75,10), OX14,NAS(13,75,11),OX2,NAS(12,75,10), OX14,NAS(13,75,11),OX2,NAS(12,75,10),
	OX14,NAS(13,75,11),OX2,NAS(12,75,10), OX14,NAS(13,75,11),OX2,NAS(12,75,10), OX14,NAS(13,75,11),OX2,NAS(12,75,10),

	OX20,OX20,OX20,NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),

	OX20,OX20,NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),

	OX20,OX20,NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),
	OX8,NAS(9,45,15),NAS(9,45,15),NAS(9,45,15),NAS(9,45,15),NAS(9,45,15),
	OX8,NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),NAS(8,45,15),

	OX20,OX20,OX20,
};
 
const unsigned char StageScene_1::stage1_f[] = {
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,33,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,33,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,33,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,33,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,33,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),
 
	SPAA(7,16,31,5,180,15),SPAA(7,16,32,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,34,5,180,15),SPAA(7,16,34,5,180,15),
	SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,36,5,180,15),SPAA(7,16,36,5,180,15),
	SPAA(7,16,36,5,180,15),SPAA(7,16,36,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),
	SPAA(7,16,34,5,180,15),SPAA(7,16,34,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,32,5,180,15),SPAA(7,16,31,5,180,15),
 
	SPAA(7,16,30,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,21,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,15,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,3,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,-3,5,180,15),SPAA(7,16,-6,5,180,15),SPAA(7,16,-9,5,180,15),SPAA(7,16,-12,5,180,15),SPAA(7,16,-15,5,180,15),
	SPAA(7,16,-18,5,180,15),SPAA(7,16,-21,5,180,15),SPAA(7,16,-24,5,180,15),SPAA(7,16,-27,5,180,15),SPAA(7,16,-30,5,180,15),SPAA(7,16,-33,5,180,15),
	SPAA(7,16,-36,5,180,15),SPAA(7,16,-33,5,180,15),SPAA(7,16,-30,5,180,15),SPAA(7,16,-27,5,180,15),SPAA(7,16,-24,5,180,15),SPAA(7,16,-21,5,180,15),
	SPAA(7,16,-18,5,180,15),SPAA(7,16,-15,5,180,15),SPAA(7,16,-12,5,180,15),SPAA(7,16,-9,5,180,15),SPAA(7,16,-6,5,180,15),SPAA(7,16,-3,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,33,5,180,15),
	SPAA(7,16,36,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,30,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,21,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,15,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,3,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,-3,5,180,15),SPAA(7,16,-6,5,180,15),SPAA(7,16,-9,5,180,15),SPAA(7,16,-12,5,180,15),SPAA(7,16,-15,5,180,15),
	SPAA(7,16,-18,5,180,15),SPAA(7,16,-21,5,180,15),SPAA(7,16,-24,5,180,15),SPAA(7,16,-27,5,180,15),SPAA(7,16,-30,5,180,15),SPAA(7,16,-33,5,180,15),
	SPAA(7,16,-36,5,180,15),SPAA(7,16,-33,5,180,15),SPAA(7,16,-30,5,180,15),SPAA(7,16,-27,5,180,15),SPAA(7,16,-24,5,180,15),SPAA(7,16,-21,5,180,15),
	SPAA(7,16,-18,5,180,15),SPAA(7,16,-15,5,180,15),SPAA(7,16,-12,5,180,15),SPAA(7,16,-9,5,180,15),SPAA(7,16,-6,5,180,15),SPAA(7,16,-3,5,180,15),
	SPAA(7,16,0,5,180,15),SPAA(7,16,3,5,180,15),SPAA(7,16,6,5,180,15),SPAA(7,16,9,5,180,15),SPAA(7,16,12,5,180,15),SPAA(7,16,15,5,180,15),
	SPAA(7,16,18,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,30,5,180,15),
 
	SPAA(7,16,31,5,180,15),SPAA(7,16,32,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,34,5,180,15),SPAA(7,16,34,5,180,15),
	SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,36,5,180,15),SPAA(7,16,36,5,180,15),
	SPAA(7,16,36,5,180,15),SPAA(7,16,36,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),SPAA(7,16,35,5,180,15),
	SPAA(7,16,34,5,180,15),SPAA(7,16,34,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,33,5,180,15),SPAA(7,16,32,5,180,15),SPAA(7,16,31,5,180,15),
 
	SPAA(7,16,30,5,180,15),SPAA(7,16,27,5,180,15),SPAA(7,16,24,5,180,15),SPAA(7,16,21,5,180,15),SPAA(7,16,18,5,180,15),
	SPAP(7,16,1,6,5,180,15),SPAP(7,16,1,7,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,13,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,19,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,25,5,180,15),
	SPAP(7,16,1,26,5,180,15),SPAP(7,16,1,25,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,19,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,13,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,7,5,180,15),
	SPAP(7,16,1,6,5,180,15),SPAP(7,16,1,7,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,13,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,19,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,25,5,180,15),
	SPAP(7,16,1,26,5,180,15),SPAP(7,16,1,25,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,19,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,13,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,7,5,180,15),
	SPAP(7,16,1,6,5,180,15),SPAP(7,16,1,7,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,13,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,19,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,25,5,180,15),
	SPAP(7,16,1,26,5,180,15),SPAP(7,16,1,25,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,19,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,13,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,7,5,180,15),
	SPAP(7,16,1,6,5,180,15),SPAP(7,16,1,7,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,13,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,19,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,25,5,180,15),
	SPAP(7,16,1,26,5,180,15),SPAP(7,16,1,25,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,19,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,13,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,7,5,180,15),
	SPAP(7,16,1,6,5,180,15),SPAP(7,16,1,7,5,180,15),SPAP(7,16,1,8,5,180,15),SPAP(7,16,1,10,5,180,15),SPAP(7,16,1,13,5,180,15),
	SPAP(7,16,1,16,5,180,15),SPAP(7,16,1,19,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,25,5,180,15),
	SPAP(7,16,1,26,5,180,15),SPAP(7,16,1,25,5,180,15),SPAP(7,16,1,24,5,180,15),SPAP(7,16,1,22,5,180,15),SPAP(7,16,1,19,5,180,15),
};

bool StageScene_1::init()
{
	GameScene::init();

	bg = BackGroundLayer::create();
	this->addChild(bg, -1000);
	dialog = DialogLayer::create();
	this->addChild(dialog, 1000);
	control = ControlLayer::create();
	this->addChild(control, 1001);

	playingFlag = false;
	setSpeed(1);

	return true;
}

void StageScene_1::initGame()
{
	player = PlayerLayer::create();
	this->addChild(player, 100);
 	enemy = EnemyLayer::create();
 	this->addChild(enemy,99);
 	danmaku = DanmakuLayer::create();
 	this->addChild(danmaku, -99);
 	obstacle = ObstacleLayer::create();
 	this->addChild(obstacle, -101);
 	medicine = MedicineLayer::create();
 	this->addChild(medicine, -100);
 	attack = AttackLayer::create();
 	this->addChild(attack, -102);
 
 	attackPower = -15;
 	medicineRegain = 800;
 	danmakuPower = -600;
 	obstaclePower = -1000;
 	playerHealthMax = 10000;
 	enemyHealthMax = 10000;
 
 	player->setHealth(playerHealthMax);
 	player->setHealthMax(playerHealthMax);
 	enemy->setHealth(enemyHealthMax);
 	enemy->setHealthMax(enemyHealthMax);
 	winFlag = false;

	process = 0;
	setSpeed(3);

	GameLogic();
}

void StageScene_1::attackSchedule()
{
	this->schedule(schedule_selector(StageScene_1::runAttack), 0.2f, UINT_MAX-1, 0);
}

void StageScene_1::danmakuSchedule()
{
	danmakuLevel = 1;
	this->schedule(schedule_selector(StageScene_1::runDanmaku), 0.025f, UINT_MAX-1, 0);
}

void StageScene_1::obstacleSchedule()
{
	obstacleLevel = 1;
	obstacleCount = 0;
	obstacleTime = 0;
	this->schedule(schedule_selector(StageScene_1::runObstacle), 0.05f, UINT_MAX-1, 0);
}

void StageScene_1::medicineSchedule()
{
	medicineTime = 0;
	this->schedule(schedule_selector(StageScene_1::runMedicine), 0.05f, UINT_MAX-1, 0);
}

void StageScene_1::runDanmaku(float dt)
{
 	switch (danmakuLevel)
 	{
 	case 1:
 		{
 			if (process >= sizeof(stage1)){process = 0;danmakuLevel++;return;}
 			stageDanmaku(stage1);
 		}
 		break;
 	case 2:
 		{
 			if (process >= sizeof(stage1_f)){process = 0;return;}
 			stageDanmaku(stage1_f);
 		}
 		break;
 
 	default:
 		break;
 	}
}

void StageScene_1::runObstacle(float dt)
{
 #define Cycle(Cycle) if(obstacleTime>=(Cycle))
 #define levelUpAfter(count) if(obstacleCount>(count)){obstacleLevel++;obstacleCount=0;}
 #define changeState obstacleTime=0;obstacleCount++;
 
 	obstacleTime++;
 	switch (obstacleLevel)
 	{
 	case 1:
 		Cycle(25)
 		{
 			setSpeed(3);
 			obstacle->randomObstacle();
 			changeState;
 			levelUpAfter(6);
 		}
 		break;
 
 	case 2:
 		Cycle(20)
 		{
 			setSpeed(4);
 			obstacle->randomObstacle();
 			changeState;
 			levelUpAfter(8)
 		}
 		break;
 
 	case 3:
 		Cycle(15)
 		{
 			setSpeed(5);
 			obstacle->randomObstacle();
 			changeState;
 			levelUpAfter(12)
 		}
 		break;
 
 	case 4:
 		Cycle(10)
 		{
 			setSpeed(6);
 			obstacle->randomObstacle();
 			changeState;
 			levelUpAfter(16)
 		}
 		break;
 
 	case 5:
 		Cycle(5)
 		{
 			setSpeed(7);
 			obstacle->randomObstacle();
 			changeState;
 			levelUpAfter(UINT_MAX-1);
 		}
 		break;
 	default:
 		break;
 	}
 
 #undef Cycle
 #undef levelUpAfter
 #undef changeState
}

void StageScene_1::runMedicine(float dt)
{
 	medicineTime++;
 	if(medicineTime >= 36)
 	{
 		medicine->randomMedicine();
 		medicineTime=0;
 	}
}

void StageScene_1::runAttack(float dt)
{
	attack->bulletAttack(player->getPlayerPosition(), enemy->getEnemyPosition());
}

void StageScene_1::Gameover()
{
	Sprite* gameover = Sprite::createWithSpriteFrameName("gameover.png");
	SETSIZE(gameover, 0.4);
	gameover->setPosition(Point(origin.x + visibleSize.width/2, origin.y + visibleSize.height/2));
	addChild(gameover, 10000);
	SimpleAudioEngine::getInstance()->stopBackgroundMusic(true);
	winFlag = true;
}

void StageScene_1::Victory()
{
	Sprite* victory = Sprite::createWithSpriteFrameName("victory.png");
	SETSIZE(victory, 0.4);
	victory->setPosition(Point(origin.x + visibleSize.width/2, origin.y + visibleSize.height/2));
	addChild(victory, 9000);
	winFlag = true;
}